Improve error handling and loop control.